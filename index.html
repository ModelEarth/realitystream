<!DOCTYPE html>
<html lang="en-us">
<head>
<meta charset="utf-8">
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>RealityStream - Machine Learning Classification Models</title>
<link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link type="text/css" rel="stylesheet" href="/localsite/css/base.css" id="/localsite/css/base.css">
<script type="text/javascript" src="/localsite/js/localsite.js?showheader=true"></script>

<!-- Load required scripts before the loadMarkdown calls -->
<script src="https://cdn.jsdelivr.net/npm/js-yaml@4/dist/js-yaml.min.js"></script>
<script>
(function normalizeIncomingFromTimeline() {
  const h = (window.location.hash || '').replace(/^#/, '');
  if (!h) return;

  const p = new URLSearchParams(h);

  // If timeline sends features.dcid/targets.dcid, move to rs_dcid so param-input.js won't override YAML.
  const incoming =
    p.get('rs_dcid') ||
    p.get('features.dcid') ||
    p.get('targets.dcid');

  if (incoming && !p.get('rs_dcid')) {
    p.set('rs_dcid', incoming);
  }

  // IMPORTANT: remove these so param-input.js cannot overwrite YAML based on them
  p.delete('features.dcid');
  p.delete('targets.dcid');

  const newHash = p.toString();
  const newUrl = window.location.pathname + window.location.search + (newHash ? '#' + newHash : '');
  window.history.replaceState(null, '', newUrl);
})();
</script>

<script>
let externalSite = "https://model.earth"; // Since cloud repo is not always a submodule.
if (location.host.indexOf('localhost') >= 0) {
  externalSite = "..";
}
loadScript(externalSite + '/cloud/run/js/param-input.js', function() {
  loadBaseParamsSelect();

  // refresh AFTER param-input has had time to write YAML into #paramText pre
  setTimeout(() => {
    if (window.rsRefreshFromYaml) window.rsRefreshFromYaml();
  }, 300);
});

</script>


<style>
#paramText {
  font-size: 0.9em;
  overflow: scroll !important;
  padding-top: 0px;
  padding-bottom: 0px;
}
button {
  background-color: #375a7f;
  border: none;
  color: white;
  padding: 10px 16px;
  font-size: 14px;
  margin: 4px 2px;
  cursor: pointer;
  border-radius: 4px;
  white-space: nowrap;
}



  .rsRowCard{
    position:relative; /* anchor popover to the card */
  }

  .rsActions{
    display:flex;
    align-items:center;
    gap:8px;
    flex-shrink:0;
  }

  .rsInfoBtn{
    width:26px;
    height:26px;
    padding:0;
    border-radius:999px;
    background:#eef3fb;
    color:#203040;
    border:1px solid #cfd8e3;
    cursor:pointer;
    font-size:12px;
    font-weight:700;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    user-select:none;
  }
  .rsInfoBtn:hover{ background:#e3ecfb; }
  .rsInfoBtn:active{ transform:scale(0.98); }

  .rsRemoveBtn{
    padding:6px 10px;
    font-size:12px;
    background:#6b7280;
    border-radius:8px;
  }

 .rsPopover{
  position:absolute;
  right:44px;              /* sits left of the i + X buttons */
  top:42px;
  width:360px;
  max-width:min(420px, calc(100vw - 60px));
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:14px;
  box-shadow:0 12px 28px rgba(0,0,0,0.12);
  padding:14px 16px;
  z-index:9999;
}

.rsPopover::before{
  content:"";
  position:absolute;
  right:-8px;
  top:18px;
  width:14px;
  height:14px;
  background:#fff;
  border-right:1px solid #e5e7eb;
  border-top:1px solid #e5e7eb;
  transform:rotate(45deg);
}

.rsPopover .k{
  font-size:11px;
  font-weight:700;
  color:#6b7280;
  letter-spacing:.06em;
  text-transform:uppercase;
  margin-top:10px;
}

.rsPopover .k:first-child{
  margin-top:0;
}

.rsPopover .v{
  font-size:13px;
  color:#111827;
  margin-top:6px;
  line-height:1.35;
  word-break:break-word;
}

.rsPopover a{
  color:#2563eb;
  text-decoration:none;
  overflow-wrap:anywhere;
}

.rsPopover a:hover{
  text-decoration:underline;
}


  .rsPopHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding-bottom:8px;
    margin-bottom:10px;
    border-bottom:1px solid rgba(0,0,0,0.06);
  }

  .rsPopTitle{
    font-size:12px;
    font-weight:700;
    color:#111827;
    letter-spacing:.02em;
    text-transform:uppercase;
  }

  .rsPopClose{
    border:none;
    background:transparent;
    cursor:pointer;
    font-size:18px;
    line-height:18px;
    padding:2px 6px;
    border-radius:8px;
    color:#6b7280;
  }
  .rsPopClose:hover{ background:#f3f4f6; color:#111827; }

  .rsPopover .k{
    font-size:11px;
    color:#6b7280;
    text-transform:uppercase;
    letter-spacing:.03em;
    margin-top:10px;
  }
  .rsPopover .v{
    font-size:13px;
    color:#111827;
    word-break:break-word;
    margin-top:3px;
  }
  .rsPopover a{
    font-size:13px;
    color:#1d4ed8;
    text-decoration:none;
    word-break:break-word;
  }
  .rsPopover a:hover{
    text-decoration:underline;
  }
</style>


<script>

loadMarkdown("README.md", "readmeDiv", "_parent");
loadMarkdown("about.md", "aboutDiv", "_parent");
loadMarkdown("input/blinks/README.md", "blinksDiv", "_parent");
loadMarkdown("input/industries/README.md", "industriesDiv", "_parent");
loadMarkdown("projects.md", "proj", "_parent");
</script>
</head>

<body>

<div class="content contentpadding" style="position:relative;">

<div style="float:right;margin-top:6px">
  <a href="https://github.com/modelearth/realitystream/"><img src="../localsite/img/icon/github/github.png" style="width:42px"></a>
</div>

<a href="/projects">Active Projects</a>
<h1>RealityStream</h1>

Scroll to the bottom for a list of RealityStream <a href="#projects">projects</a>.<br>
View <a href="../reports/">Report Output</a> (Under Development) - View <a href="../reports/2025/eye-blinks-rbf-2025-10-30/">Eye Blink Detection sample report</a><br><br>

<select id="parambase"></select><br>

<div id="addControls" style="margin-top:10px; display:flex; gap:10px; align-items:center;">
  <button id="addBtn" type="button">+ Add</button>
</div>

<!-- Popup -->
<div id="rsAddBackdrop" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.15); z-index:9998;"></div>

<div id="rsAddPopup" style="display:none; position:fixed; top:120px; left:50%; transform:translateX(-50%);
  width:360px; background:#fff; border:1px solid #ddd; border-radius:10px; padding:12px; z-index:9999; box-shadow:0 10px 25px rgba(0,0,0,0.15);">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <div style="font-weight:600;">Add dataset</div>
    <button id="rsAddClose" type="button" style="border:none; background:transparent; font-size:18px; cursor:pointer;">×</button>
  </div>

  
  <div style="display:flex; gap:12px; margin-top:6px;">
    <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
      <input type="radio" name="rs_role" value="features" checked> Features
    </label>
    <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
      <input type="radio" name="rs_role" value="target"> Targets
    </label>
  </div>

  <div style="margin-top:12px; font-size:13px; color:#444;">Select from:</div>

  <div style="display:flex; flex-direction:column; gap:10px; margin-top:8px;">
    <button id="rsAddTimelines" type="button"
      style="text-align:left; padding:10px; border-radius:8px; border:1px solid #ddd; background:#375a7f; cursor:pointer;">
      Google Data Commons Timelines
      
    </button>

    <button id="rsAddNaics" type="button"
      style="text-align:left; padding:10px; border-radius:8px; border:1px solid #ddd; background: #375a7f; cursor:pointer;">
      US Industry NAICS Data
      
    </button>
  </div>
</div>
<div id="rsJoinStatus"
  style="display:none; margin:10px 0 6px 0; padding:10px 12px; border:1px solid #e6e6e6; border-radius:10px; background:#fafafa; font-size:13px;">
</div>

<div id="rsPickers" style="margin: 10px 0 12px 0; display:flex; gap:14px; flex-wrap:wrap;">
  <!-- FEATURES -->
  <div style="flex:1; min-width:320px;">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
      <div style="font-weight:600;">Features</div>
      <!-- <span style="font-size:12px; color:#666;">Drag rows to Target</span> -->
    </div>

    <div id="rsFeaturesDrop"
      style="border:1px solid #ddd; border-radius:10px; padding:10px; background:#fafafa; min-height:74px;">
      <div id="rsFeaturesList" style="display:flex; flex-direction:column; gap:8px;"></div>
      <div id="rsFeaturesEmpty" style="font-size:10px; color:#777; margin-top:6px;">
        No features selected yet.
      </div>
    </div>
  </div>

  <!-- TARGET -->
  <div style="flex:1; min-width:320px;">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
      <div style="font-weight:600;">Target</div>
      <!-- <span style="font-size:12px; color:#666;">Drop 1 row here</span> -->
    </div>

    <div id="rsTargetDrop"
      style="border:1px solid #ddd; border-radius:10px; padding:10px; background:#fafafa; min-height:74px;">
      <div id="rsTargetList" style="display:flex; flex-direction:column; gap:8px;"></div>
      <div id="rsTargetEmpty" style="font-size:10px; color:#777; margin-top:6px;">
        No target selected yet.
      </div>
    </div>
  </div>
</div>


<div id="paramText" class="codetext" contenteditable>
<pre>
folder: naics6-bees-counties

features:
  data: industries
  common: Fips
  path: https://raw.githubusercontent.com/ModelEarth/community-timelines/main/training/naics6/US/counties/2020/US-ME-training-naics6-counties-2020.csv

targets:
  data: bees
  path: https://raw.githubusercontent.com/ModelEarth/bee-data/main/targets/bees-targets-top-20-percent.csv

models: xgboost
</pre>
</div>
Edit your yaml above and paste into our <a href="input/industries/">Run Models CoLab</a>.<br><br>


  <div id="aboutDiv"></div>
  <div id="pathDiv"></div><br>

  <div class="pagecard">
  <div class="cardstyle">
    <div id="blinksDiv"></div>
  </div>
  </div>

  <div class="pagecard">
  <div class="cardstyle">
    <div id="industriesDiv"></div>
  </div>
  </div>

<hr>

<div id="readmeDiv"></div>


<b><a href="input/industries">Run Models CoLab documentation</a></b><br>

<!--
<b><a href="streamlit">Streamlit App documentation</a></b> -   
<a href="https://reality.streamlit.app/">reality.streamlit.app</a> | 
<a href="https://share.streamlit.io/">My streamlit apps</a> | 
<a href="https://echarts.streamlit.app/">echarts.streamlit.app</a><br>
-->

<span style="display:none" class="local"><br><a href="https://docs.google.com/document/d/1aR3VjrQj94X542uzJ-qXwRgIH8SzcLzE0z_jfT8bYbU/">Hosting notes Google Doc</a></span>

<!--
  https://laughing-orbit-6475wr7w55j2rrjq.github.dev/
-->
<br><br>

<div id="proj"></div>

</div>
<script>
  function rsOpenAddPopup() {
    document.getElementById('rsAddPopup').style.display = 'block';
    document.getElementById('rsAddBackdrop').style.display = 'block';
  }

  function rsCloseAddPopup() {
    document.getElementById('rsAddPopup').style.display = 'none';
    document.getElementById('rsAddBackdrop').style.display = 'none';
  }

  function rsGetSelectedRole() {
    const chosen = document.querySelector('input[name="rs_role"]:checked');
    return chosen ? chosen.value : 'features';
  }

  // Keep existing hash params + add rs_role & rs_source, then navigate
  // Keep existing hash params + add rs_role & rs_source, then navigate
function rsNavigateWithHash(destPath, source) {
  const role = rsGetSelectedRole();

 
  if (role === 'target' && window.rsHasTarget && window.rsHasTarget()) {
    alert('Only 1 target is allowed. Remove the current target first.');
    return;
  }

  const h = (window.location.hash || '').replace(/^#/, '');
  const p = new URLSearchParams(h);

  p.set('rs_role', role);
  p.set('rs_source', source);

  rsCloseAddPopup();
  window.location.href = destPath + '#' + p.toString();
}



  document.addEventListener('DOMContentLoaded', function() {
    const addBtn = document.getElementById('addBtn');
    const closeBtn = document.getElementById('rsAddClose');
    const backdrop = document.getElementById('rsAddBackdrop');
    const btnTimelines = document.getElementById('rsAddTimelines');
    const btnNaics = document.getElementById('rsAddNaics');

    if (addBtn) addBtn.addEventListener('click', rsOpenAddPopup);
    if (closeBtn) closeBtn.addEventListener('click', rsCloseAddPopup);
    if (backdrop) backdrop.addEventListener('click', rsCloseAddPopup);

    // Destination pages:
    // - Timelines picker: localsite timeline page
    // - NAICS picker: localsite info page (your current “features” link)
    if (btnTimelines) btnTimelines.addEventListener('click', function() {
      rsNavigateWithHash('/localsite/timeline/', 'timelines');
    });

    if (btnNaics) btnNaics.addEventListener('click', function() {
      rsNavigateWithHash('/localsite/info', 'naics');
    });

    // ESC closes popup
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') rsCloseAddPopup();
    });
  });
</script>



<script>
(function() {
  const state = {
    features: [], // array of { id, dcid, label }
    target: null // { id, dcid, label } or null
  };
let isSyncingYaml = false;
let yamlRefreshTimer = null;
let hasConsumedIncoming = false;
let hasSeenBaseYaml = false;

window.rsHasTarget = function () {
  return !!(state.target && state.target.dcid);
};


  function uid() {
    return 'id_' + Math.random().toString(16).slice(2);
  }

  function getHashParams() {
  const h = (window.location.hash || '').replace(/^#/, '');
  return new URLSearchParams(h);
}

function setHashParams(p) {
  const newHash = p.toString();
  history.replaceState(null, '', window.location.pathname + window.location.search + (newHash ? '#' + newHash : ''));
}

function readCsvParam(p, key) {
  const v = (p.get(key) || '').trim();
  if (!v) return [];
  return v.split(',').map(s => s.trim()).filter(Boolean);
}

function writeCsvParam(p, key, list) {
  const unique = Array.from(new Set(list.map(s => s.trim()).filter(Boolean)));
  if (!unique.length) p.delete(key);
  else p.set(key, unique.join(','));
}


function syncHashFromState() {
  const p = getHashParams();
  writeCsvParam(p, 'rs_features', state.features.map(x => x.dcid));

  if (state.target?.dcid) p.set('rs_target', state.target.dcid);
  else p.delete('rs_target');

  const newHash = p.toString();
  history.replaceState(null, '', window.location.pathname + (newHash ? '#' + newHash : ''));
}

function closeAllPopovers() {
  document.querySelectorAll('.rsPopover').forEach(p => p.remove());
}

document.addEventListener('click', (e) => {
  // click outside closes
  if (!e.target.closest('.rsPopover') && !e.target.closest('.rsInfoBtn')) {
    closeAllPopovers();
  }
});


  function createRowCard(item, role) {
    const el = document.createElement('div');
    el.className = 'rsRowCard';
    el.draggable = true;
    el.dataset.id = item.id;
    el.dataset.role = role;

    el.style.display = 'flex';
    el.style.alignItems = 'center';
    el.style.justifyContent = 'space-between';
    el.style.gap = '10px';
    el.style.padding = '10px';
    el.style.border = '1px solid #ddd';
    el.style.borderRadius = '10px';
    el.style.background = '#fff';
    el.style.cursor = 'grab';

    const left = document.createElement('div');
    left.style.display = 'flex';
    left.style.flexDirection = 'column';

    const title = document.createElement('div');
    title.style.fontWeight = '600';
    title.style.fontSize = '13px';   
    title.textContent = item.label || item.dcid;
   const titleRow = document.createElement('div');
titleRow.style.display = 'flex';
titleRow.style.alignItems = 'center';
titleRow.style.gap = '8px';

titleRow.appendChild(title);
left.appendChild(titleRow);

    
  

    const right = document.createElement('div');
    right.className = 'rsActions';
    right.style.display = 'flex';
    right.style.gap = '8px';


   // info icon (only if we have something useful to show)
if (item.kind && (item.href || item.dcid || item.fullPath)) {
  const infoBtn = document.createElement('button');
  infoBtn.type = 'button';
  infoBtn.textContent = 'i';
  infoBtn.title = 'Info';
  infoBtn.className = 'rsInfoBtn';
  infoBtn.draggable = false;

  // prevent drag on click
  infoBtn.addEventListener('mousedown', (e) => {
    e.preventDefault();
    e.stopPropagation();
  });

  infoBtn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();

    const existing = el.querySelector('.rsPopover');
    if (existing) { existing.remove(); return; }

    closeAllPopovers();

    const pop = document.createElement('div');
    pop.className = 'rsPopover';

    const kindLabel = (item.kind || '').toUpperCase();
    const value = item.dcid || '';
    const link = item.href || '';
    const fullPath = item.fullPath || '';

  pop.innerHTML = `
  <div class="k">${kindLabel || 'DCID'}</div>
  <div class="v">${value || '-'}</div>

  ${link ? `
    <div class="k">LINK</div>
    <div class="v">
      <a href="${link}" target="_blank" rel="noopener noreferrer">${link}</a>
    </div>
  ` : ''}

  ${fullPath ? `
    <div class="k">PATH</div>
    <div class="v">
      <a href="${fullPath}" target="_blank" rel="noopener noreferrer">${fullPath}</a>
    </div>
  ` : ''}
`;



 

    el.appendChild(pop);
  });

  // ✅ THIS is the key change:
  right.appendChild(infoBtn);
}

const removeBtn = document.createElement('button');
removeBtn.type = 'button';
removeBtn.textContent = 'X';
removeBtn.className = 'rsRemoveBtn';

// prevent drag on click
removeBtn.draggable = false;
removeBtn.addEventListener('mousedown', (e) => {
  e.preventDefault();
  e.stopPropagation();
});
removeBtn.addEventListener('click', (e) => {
  e.preventDefault();
  e.stopPropagation();
  removeItem(item.id);
});

right.appendChild(removeBtn);
    el.appendChild(left);
    el.appendChild(right);

    el.addEventListener('dragstart', (e) => {
      e.dataTransfer.setData('text/plain', JSON.stringify({
        id: item.id,
        from: role
      }));
    
      setTimeout(() => el.style.opacity = '0.6', 0);
    });

    el.addEventListener('dragend', () => {
      el.style.opacity = '1';
    });

    return el;
  }

function updateJoinStatus() {
  const el = document.getElementById('rsJoinStatus');
  if (!el) return;

  // Only show when both features and target exist
  const hasFeature = Array.isArray(state.features) && state.features.length > 0;
  const hasTarget = !!(state.target && state.target.dcid);

  if (!hasFeature || !hasTarget) {
    el.style.display = 'none';
    el.textContent = '';
    return;
  }

  // scope comes from URL hash (Timeline already passes scope=country)
  const p = getHashParams();
  const scope = (p.get('scope') || 'country').trim() || 'country';

  // common comes from YAML: features.common
  let common = '';
  try {
    const paramTextDiv = document.getElementById('paramText');
    const preTag = paramTextDiv ? paramTextDiv.querySelector('pre') : null;
    if (preTag && window.jsyaml) {
      const yamlObj = jsyaml.load(preTag.textContent) || {};
      common = (yamlObj.features && yamlObj.features.common) ? String(yamlObj.features.common).trim() : '';
    }
  } catch (e) {
    // ignore YAML parse errors while user is typing
  }

  if (!common) {
    el.style.display = 'none';
    el.textContent = '';
    return;
  }

 
  const COMMON_LABELS = {
    Fips: 'FIPS',
    fips: 'FIPS',
    Iso2: 'Country ID (ISO2)',
    iso2: 'Country ID (ISO2)',
    PostalCode: 'Postal Code',
    postalcode: 'Postal Code',
    Voxel: 'Voxel',
    voxel: 'Voxel'
  };
  const commonLabel = COMMON_LABELS[common] || common;

  el.textContent = `Joining on: ${scope} using common ${commonLabel}`;
  el.style.display = 'block';
}



 function render(shouldSyncYaml = true) {
  const fList = document.getElementById('rsFeaturesList');
  const tList = document.getElementById('rsTargetList');
  const fEmpty = document.getElementById('rsFeaturesEmpty');
  const tEmpty = document.getElementById('rsTargetEmpty');

  fList.innerHTML = '';
  tList.innerHTML = '';

  state.features.forEach(item => fList.appendChild(createRowCard(item, 'features')));
  if (state.target) tList.appendChild(createRowCard(state.target, 'target'));

  fEmpty.style.display = state.features.length ? 'none' : 'block';
  tEmpty.style.display = state.target ? 'none' : 'block';

   updateJoinStatus(); 

  if (shouldSyncYaml) syncYamlFromState();
}



  function removeItem(id) {
    state.features = state.features.filter(x => x.id !== id);
    if (state.target && state.target.id === id) state.target = null;
    syncHashFromState();
    render();
  }

 function moveItem(id, from, to) {
  if (from === to) return;

  let item = null;

  // Remove from source
  if (from === 'features') {
    const idx = state.features.findIndex(x => x.id === id);
    if (idx >= 0) {
      item = state.features[idx];
      state.features.splice(idx, 1);
    }
  } else if (from === 'target') {
    if (state.target && state.target.id === id) {
      item = state.target;
      state.target = null;
    }
  }

  if (!item) return;

  // Drop into destination
  if (to === 'target') {
    // don’t allow replacing an existing target
    if (state.target) {
      alert('Only 1 target is allowed. Remove the current target first.');

      // put the item back where it came from
      if (from === 'features') state.features.push(item);
      else state.target = item;

      // keep hash consistent too
      syncHashFromState();
      render(false); // don’t rewrite YAML here
      return;
    }
    state.target = item;
  } else {
    state.features.push(item);
  }

  
  syncHashFromState();

  render(); // will sync YAML
}


  function setupDropZone(zoneId, role) {
    const zone = document.getElementById(zoneId);
    zone.addEventListener('dragover', (e) => {
      e.preventDefault();
      zone.style.borderColor = '#4CAF50';
    });
    zone.addEventListener('dragleave', () => {
      zone.style.borderColor = '#ddd';
    });
    zone.addEventListener('drop', (e) => {
      e.preventDefault();
      zone.style.borderColor = '#ddd';
      try {
        const data = JSON.parse(e.dataTransfer.getData('text/plain'));
        moveItem(data.id, data.from, role);
      } catch (err) {
        console.warn('Bad drag data', err);
      }
    });
  }

 
  // This updates features.dcid / targets.dcid in YAML based on UI.
  function syncYamlFromState() {
    
    const paramTextDiv = document.getElementById('paramText');
    const preTag = paramTextDiv ? paramTextDiv.querySelector('pre') : null;
    
    if (!preTag || !window.jsyaml) return;

    isSyncingYaml = true;

    let yamlObj;
    try {
      yamlObj = jsyaml.load(preTag.textContent) || {};
    } catch (e) {
      return; // if YAML is mid-edit and invalid, don't break anything
    }

    // Ensure objects exist
    yamlObj.features = yamlObj.features || {};
    yamlObj.targets = yamlObj.targets || {};

 
 const featureDcids = state.features.map(x => x.dcid);

if (featureDcids.length === 0) {
  delete yamlObj.features.dcid;
} else {
  //always store as comma-separated string
  yamlObj.features.dcid = featureDcids.join(', ');
}



    if (!state.target) {
      delete yamlObj.targets.dcid;
    } else {
      yamlObj.targets.dcid = state.target.dcid;
    }

    const newYaml = jsyaml.dump(yamlObj, { lineWidth: -1, noCompatMode: true });
    preTag.textContent = newYaml;
    setTimeout(() => { isSyncingYaml = false; }, 0);

  }


  function looksLikeBaseYamlLoaded(preText) {
  if (!preText) return false;
  // any one of these is enough to know param-input has written a real YAML
  return preText.includes('folder:') || preText.includes('features:') || preText.includes('targets:') || preText.includes('models:');
}


function splitCsvOrArray(v) {
  if (!v) return [];
  if (Array.isArray(v)) return v.map(x => String(x).trim()).filter(Boolean);
  if (typeof v === 'string') {
    return v.split(',').map(s => s.trim()).filter(Boolean);
  }
  return [String(v).trim()].filter(Boolean);
}

function filenameFromPath(path) {
  if (!path || typeof path !== 'string') return '';
  const clean = path.split('?')[0].split('#')[0];
  const parts = clean.split('/');
  return (parts[parts.length - 1] || '').trim();
}

// For Features, the UI picks features.dcid if it exists otherwise features.data otherwise the filename from features.path
// For Target, it picks targets.dcid if it exists otherwise targets.data otherwise the filename from targets.path
function pickYamlIdsAndLabeler(sectionObj) {
  sectionObj = sectionObj || {};

  const dcids = splitCsvOrArray(sectionObj.dcid);
  if (dcids.length) {
    return dcids.map(v => ({
      value: v,
      label: v,
      kind: 'dcid',
      href: `https://datacommons.org/browser/${encodeURIComponent(v)}`
    }));
  }

  const datas = splitCsvOrArray(sectionObj.data);
  if (datas.length) {
    return datas.map(v => ({
      value: v,
      label: v,
      kind: 'data',
      href: '' // optional: if you later want a docs link per dataset
    }));
  }

  const paths = splitCsvOrArray(sectionObj.path);
  if (paths.length) {
    return paths.map(p => {
      const file = filenameFromPath(p) || p;
      return {
        value: file,     // keep card short
        label: file,     // show filename
        kind: 'path',
        href: p          // full raw URL (clickable)
      };
    });
  }

  return [];
}





 
  // This can read existing YAML and prefill cards later.
  function refreshFromYaml() {
    // if (hasConsumedIncoming) return;

  const paramTextDiv = document.getElementById('paramText');
  const preTag = paramTextDiv ? paramTextDiv.querySelector('pre') : null;
  if (!preTag || !window.jsyaml) return;

  if (isSyncingYaml) return;

  // If the hash already has rs_features, do NOT rebuild features from YAML.
  const p = getHashParams();
  const hashFeatures = readCsvParam(p, 'rs_features');
  const hashTarget = (p.get('rs_target') || '').trim();

  try {
    const yamlObj = jsyaml.load(preTag.textContent) || {};

    // Only rebuild features from YAML when hash doesn't control them
   // Only rebuild features from YAML when hash doesn't control them
// Only rebuild from YAML when hash doesn't control them
if (!hashFeatures.length) {
  const picked = pickYamlIdsAndLabeler(yamlObj.features);
  const featurePath = (yamlObj.features && yamlObj.features.path) ? yamlObj.features.path : '';

  state.features = picked.map(x => ({
    id: uid(),
    dcid: x.value,     // stored value (dcid/data/filename)
    label: x.label,    // what you show
    kind: x.kind,
    href: x.href,
    fullPath: featurePath
  }));
} else {
  state.features = hashFeatures.map(v => ({ id: uid(), dcid: v, label: v, kind: 'dcid', href: `https://datacommons.org/browser/${encodeURIComponent(v)}` }));
}


// Target: prefer hashTarget if present, else YAML
if (hashTarget) {
  state.target = { id: uid(), dcid: hashTarget, label: hashTarget, kind: 'dcid', href: `https://datacommons.org/browser/${encodeURIComponent(hashTarget)}` };
} else {
  const pickedT = pickYamlIdsAndLabeler(yamlObj.targets);
  const x = pickedT[0];
  const targetPath = (yamlObj.targets && yamlObj.targets.path) ? yamlObj.targets.path : '';


  state.target = x ? {
    id: uid(),
    dcid: x.value,
    label: x.label,
    kind: x.kind,
    href: x.href,
    fullPath: targetPath
  } : null;
}






    render(false); // don't rewrite YAML while refreshing
    // syncYamlFromState();
  } catch (e) {
    // ignore invalid YAML while user types
  }
}

window.rsRefreshFromYaml = refreshFromYaml;


  document.addEventListener('DOMContentLoaded', () => {
  // Features drop targets
setupDropZone('rsFeaturesDrop', 'features');
setupDropZone('rsFeaturesList', 'features');
setupDropZone('rsFeaturesEmpty', 'features');

// Target drop targets
setupDropZone('rsTargetDrop', 'target');
setupDropZone('rsTargetList', 'target');
setupDropZone('rsTargetEmpty', 'target');

const p0 = getHashParams();
const savedFeatures = readCsvParam(p0, 'rs_features'); // comma separated
const savedTarget = (p0.get('rs_target') || '').trim();

if (savedFeatures.length) {
  state.features = savedFeatures.map(dcid => ({ id: uid(), dcid, label: dcid }));
}
if (savedTarget) {
  state.target = { id: uid(), dcid: savedTarget, label: savedTarget };
}

  refreshFromYaml();  // initial read
  render(false);           // initial render

  setTimeout(() => {
  const didConsume = consumeIncomingDcidFromHash();
  if (didConsume) hasConsumedIncoming = true;
}, 300);


  // Watch YAML box for changes (param-input.js updates it after load)
  const paramTextDiv = document.getElementById('paramText');
  const preTag = paramTextDiv ? paramTextDiv.querySelector('pre') : null;
// Snapshot the initial YAML that was in the HTML (before param-input.js rewrites it)
const initialPreText = preTag ? preTag.textContent : '';

  if (preTag) {
  const observer = new MutationObserver(() => {
    if (yamlRefreshTimer) clearTimeout(yamlRefreshTimer);

    yamlRefreshTimer = setTimeout(() => {
      // 1) Always rebuild UI from YAML
      refreshFromYaml();

      // 2) Try consuming incoming timeline selection once
      if (!hasConsumedIncoming) {
        const didConsume = consumeIncomingDcidFromHash();
        if (didConsume) hasConsumedIncoming = true;
      }
    }, 100);
  });

  observer.observe(preTag, { childList: true, subtree: true, characterData: true });
}


   
  document.addEventListener('hashChangeEvent', () => {
    if (yamlRefreshTimer) clearTimeout(yamlRefreshTimer);
    yamlRefreshTimer = setTimeout(() => {
      refreshFromYaml();
    }, 50);
  });


  // When user changes Base parameters dropdown, param-input.js will update YAML + hash.
// Force refresh after that happens.
const parambaseEl = document.getElementById('parambase');
if (parambaseEl) {
  parambaseEl.addEventListener('change', () => {
    if (yamlRefreshTimer) clearTimeout(yamlRefreshTimer);
    yamlRefreshTimer = setTimeout(() => refreshFromYaml(), 150);
  });
}

// Also react to real hash changes (fallback in case custom event isn't fired)
window.addEventListener('hashchange', () => {
  if (yamlRefreshTimer) clearTimeout(yamlRefreshTimer);
  yamlRefreshTimer = setTimeout(() => refreshFromYaml(), 150);
});


  window.rsAddSelection = function(role, dcid, label) {
  const item = { id: uid(), dcid, label: label || dcid };

  if (role === 'target') {
   
    if (state.target) {
      alert('Only 1 target is allowed. Remove the current target first.');
      return;
    }
    state.target = item;

  } else {
    // prevent duplicates
    const exists = state.features.some(x => x.dcid === dcid);
    if (!exists) state.features.push(item);
  }

  syncHashFromState();
  render();
};

function consumeIncomingDcidFromHash() {
  const p = getHashParams();

  const incomingRaw = (p.get('rs_dcid') || '').trim();
  if (!incomingRaw) return false;

  // support comma-separated incoming dcids
  const incomingList = incomingRaw
    .split(',')
    .map(s => s.trim())
    .filter(Boolean);

  if (!incomingList.length) return false;

  let role = (p.get('rs_role') || 'features').trim();
  if (role === 'targets') role = 'target';

  if (role === 'target') {
   if (state.target && state.target.dcid) {
    alert('Only 1 target is allowed. Remove the current target first.');

    // ✅ very important: don’t keep re-triggering
    p.delete('rs_dcid');
    setHashParams(p);
    return true;
  }

  const dcid = incomingList[0];
  p.set('rs_target', dcid);
  window.rsAddSelection('target', dcid, dcid);
  } else {
    // append ALL incoming to rs_features
    const current = readCsvParam(p, 'rs_features');
    incomingList.forEach(dcid => {
      if (!current.includes(dcid)) current.push(dcid);
      window.rsAddSelection('features', dcid, dcid);
    });
    writeCsvParam(p, 'rs_features', current);
  }

  // remove single-use incoming param
  p.delete('rs_dcid');
  setHashParams(p);

  return true;
}








});

})();
</script>

</body>
</html>